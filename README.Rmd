---
title: "ROMOPOmics - An OMOPOmics R package"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    keep_md: yes
    print_df: paged
  github_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = F,message = F)
```

# ROMOPOmics

## Installation

```{r installation,eval=F}
devtools::install_github("AndrewC160/ROMOPomics",force=T) #for installation reference and not run
```

## Description

ROMOPOmics standardizes metadata of high throughput assays with associated patient clinical data. Our package ROMOPOmics provides a framework to standardize these datasets and a pipeline to convert this information into a SQL-friendly database that is easily accessed by users. After installation of our R package from the github repository, users specify a data directory and a mask file describing how to map their data's fields into a common data model. The resulting standardized data tables are then formatted into a SQLite database for easily interoperating and sharing the dataset.

```{r codeFlowChart, fig.align = 'center', out.width = "100%", echo=FALSE,fig.cap = "Flow chart of essential functions for a basic ROMOPOmics implementation using two different input datasets."}
knitr::include_graphics("man/figures/romopomics_code_flow.png")
```

## Package overview

See our vignette [ROMOPOmics](vignettes/ROMOPOmics.Rmd)

## Use Cases

```{r}
library(ROMOPOmics)
```

### TCGA data

```{r tcga-usecase}
dirs          <- list()
dirs$base     <- file.path(rprojroot::find_root(criterion = rprojroot::criteria$is_r_package))
dirs$figs     <- file.path(dirs$base,"man/figures")
dirs$demo     <- file.path(dirs$base,"demo")
dirs$data     <- file.path(dirs$demo,"data")
dirs$masks    <- file.path(dirs$demo,"masks")
dm_file     <- system.file("extdata","OMOP_CDM_v6_0_custom.csv",package="ROMOPOmics",mustWork = TRUE)
dm          <- loadDataModel(master_table_file = dm_file)
tcga_files  <- list(brca_clinical=file.path(dirs$data,"brca_clinical.csv"),
                    brca_mutation=file.path(dirs$data,"brca_mutation.csv"))
msks        <- list(brca_clinical=loadModelMasks(file.path(dirs$masks,"brca_clinical_mask.tsv")),
                    brca_mutation=loadModelMasks(file.path(dirs$masks,"brca_mutation_mask.tsv")))
omop_inputs <- list(brca_clinical=readInputFile(input_file = tcga_files$brca_clinical,
                                                 data_model = dm,
                                                 mask_table = msks$brca_clinical),
                    brca_mutation=readInputFile(input_file = tcga_files$brca_mutation,
                                                 data_model = dm,
                                                 mask_table = msks$brca_mutation))
db_inputs   <- combineInputTables(input_table_list = omop_inputs)
omop_db     <- buildSQLDBR(omop_tables = db_inputs,file.path(dirs$data,"TCGA.sqlite"))
DBI::dbListTables(omop_db)
```

### ATAC-seq data

```{r atacseq-usecase}
dm_file     <- system.file("extdata","OMOP_CDM_v6_0_custom.csv",package="ROMOPOmics",mustWork = TRUE)
dm          <- loadDataModel(master_table_file = dm_file)

msk_file    <- file.path(dirs$masks,"GSE60682_standard_mask.tsv")
msks        <- loadModelMasks(msk_file)

in_file     <- file.path(dirs$data,"GSE60682_standard.tsv")
omop_inputs <- readInputFile(input_file=in_file,data_model=dm,mask_table=msks,transpose_input_table = TRUE)
db_inputs   <- combineInputTables(input_table_list = omop_inputs)
omop_db     <- buildSQLDBR(omop_tables = db_inputs, sql_db_file=file.path(dirs$data,"GSE60682_sqlDB.sqlite"))
DBI::dbListTables(omop_db)
```

### GEO accessions from Stevens et al. 2013

```{r geo-usecase,eval=TRUE}

library(Biobase)

gse_ids <- c("GSE9006", "GSE26440", "GSE11504", "TABM666", "GSE6011", "GSE37721", "GSE20307", "GSE20436")

stevens_gse_lst <- fetch_geo_series(gse_ids,data_dir = "data/")

stevens_gse_lst$merged_metadata

```

