---
title: "GEOquery Interface"
author: "Andrew"
date: "9/30/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE)
library(GEOquery)
library(tidyverse)
library(rmarkdown)
library(kableExtra)
library(RCurl)
base_dir  <- "/data/projects/andrew/ROMOPOmics"
data_dir  <- file.path(base_dir,"geo_interface/data")
src_dir   <- file.path(base_dir,"geo_interface/R")
lapply(dir(src_dir,full.names = TRUE),source)
```

GEO has an available API package called [GEOquery](https://www.bioconductor.org/packages/release/bioc/html/GEOquery.html), and it appears to go a long way toward wrangling data files in a way that should be eas(ier) to compile into a mask. In an ideal world, we can call a `importGEO()` function which **A)** Downloads a GEO dataset (GDS) using their API (it's quite handy and effective, see below), **B)** constructs a mask file, and **C)** provides an easy interface with which users can modify column names, pick and choose column data to include, etc. **A** and **B** should be readily doable, **C** may be better served by a Shiny application, which is certainly doable but may be a bit time consuming.

###Definitions

* **Platforms:** Describes elements of an array (cDNAs, probe sets, antibodies, etc.) OR elements that may be detected and / or quantified in that data set (peptides, SAGE tags, etc.).
    + **GPLxxx**
* **Samples:** Sample records describe sample handling, manipulations to each, and abundance measurements.
    + **GSMxxx**
* **Series:** Set of related `Samples` that are part of a group, how they are related, and how they are ordered. Provides focal point and description of the experiment, and may contain tables of extracted data, summary conclusions, and/or analyses.
    + **GSExxx**
* **DataSets:** Curated sets of GEO sample data; a collection of biologically and statistically comparable GEO samples, the basis of GEOquery tools. Samples in a `DataSet` share the same `Platform`, and calculations are (presumed) to be calculated in the same way (background processing, normalizing, etc.).
    + **GDSxxx**

##fetch_geo_datasets()

Function accepts one or more strings for GEO datasets (always format "GDSnnn") and retrieves all associated GDS, GPL, and GSE objects. For each, a metadata table is returned as well, and if multiple datasets are included in the list a merged metadata table is returned.

```{r get_geo_dataset}
geos  <- fetch_geo_datasets(geo_dataset_ids = c("GDS507","GDS508","GDS509"),data_dir = data_dir)
md    <- geos$merged_metadata
```

### Metadata dimensions:
`r lapply(geos[-length(geos)], function(x) dim(x$metadata))`

### Combined metadata:
`r dim(md)`

```{r displayMetadata,echo=FALSE}
md %>%
  group_by(gds_id) %>%
  select(sample,Value,gds_platform,ftp_loc) %>%
  distinct() %>%
  ungroup() %>%
  kable() %>%
  kable_styling(full_width = FALSE)



```